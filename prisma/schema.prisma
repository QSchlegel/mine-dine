// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User model - Stores user information with Better Auth
model User {
  id            String   @id @default(cuid())
  utxosUserId   String?  @unique // Legacy UTXOS user ID (optional for migration)
  email         String?  @unique
  emailVerified Boolean  @default(false)
  name          String?
  bio           String?
  profileImageUrl String?
  coverImageUrl  String?
  role          UserRole @default(USER)
  referralCode  String?  @unique // Moderator referral code
  banned        Boolean? @default(false)
  banReason     String?
  banExpires    DateTime?
  hasCompletedGuestTour Boolean @default(false)
  hasCompletedHostTour   Boolean @default(false)
  helpPreferences        Json?   // Store user preferences for help display
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Better Auth relations
  sessions      Session[]
  accounts      Account[]
  passkeys      Passkey[]

  // Application relations
  hostApplication HostApplication?
  reviewedHostApplications HostApplication[] @relation("HostApplicationReviewer")
  onboardedHostApplications HostApplication[] @relation("HostApplicationOnboarder")
  dinners         Dinner[]
  moderatedDinners Dinner[] @relation("DinnerModerator")
  bookings        Booking[]
  reviews         Review[]
  sentMessages    Message[] @relation("MessageSender")
  receivedMessages Message[] @relation("MessageRecipient")
  userTags        UserTag[]
  swipeActions    SwipeAction[] @relation("SwipeUser")
  targetSwipeActions SwipeAction[] @relation("SwipeTarget")
  revenueShares   RevenueShare[]

  @@index([utxosUserId])
  @@index([email])
  @@index([role])
  @@index([referralCode])
}

enum UserRole {
  USER
  HOST
  MODERATOR
  ADMIN
}

// HostApplication model - Host application submissions
model HostApplication {
  id             String            @id @default(cuid())
  userId         String            @unique
  status         HostApplicationStatus @default(PENDING)
  applicationText String           @db.Text
  rejectionReason String?
  reviewedById   String?
  reviewedAt     DateTime?
  onboardedById  String?           // Moderator who approved/onboarded this host
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  // Relations
  user           User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  reviewedBy     User?             @relation("HostApplicationReviewer", fields: [reviewedById], references: [id])
  onboardedBy   User?             @relation("HostApplicationOnboarder", fields: [onboardedById], references: [id])

  @@index([status])
  @@index([userId])
  @@index([onboardedById])
}

enum HostApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

// Tag model - Tags for matching guests and hosts
model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  category  TagCategory
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // Relations
  userTags   UserTag[]
  dinnerTags DinnerTag[]

  @@index([category])
  @@index([name])
}

enum TagCategory {
  CUISINE
  DIETARY
  INTEREST
  LIFESTYLE
  SKILL
  OTHER
}

// UserTag model - Many-to-many relationship between users and tags
model UserTag {
  id        String   @id @default(cuid())
  userId    String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([userId, tagId])
  @@index([userId])
  @@index([tagId])
}

// Dinner model - Dinner event listings
model Dinner {
  id                String        @id @default(cuid())
  hostId            String
  title             String
  description       String        @db.Text
  cuisine           String?
  maxGuests         Int           @default(10)
  basePricePerPerson Float         @default(50.0) // Base price in EUR
  location          String
  dateTime          DateTime
  imageUrl          String?
  status            DinnerStatus  @default(DRAFT)
  moderationStatus  DinnerModerationStatus @default(PENDING)
  moderatedById     String?
  moderatedAt       DateTime?
  planningMode      PlanningMode @default(MANUAL)
  aiPlanData       Json?        // Store AI-generated plan data
  menuItems        Json?         // Structured menu items from AI
  prepTimeline     Json?         // Prep and cooking timeline
  ingredientList   Json?         // Shopping list
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relations
  host              User          @relation(fields: [hostId], references: [id], onDelete: Cascade)
  moderatedBy       User?         @relation("DinnerModerator", fields: [moderatedById], references: [id])
  bookings          Booking[]
  reviews           Review[]
  tags              DinnerTag[]
  addOns            DinnerAddOn[]
  groceryBills      GroceryBill[]
  dinnerPlan        DinnerPlan?

  @@index([hostId])
  @@index([status])
  @@index([moderationStatus])
  @@index([dateTime])
}

enum DinnerStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum DinnerModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PlanningMode {
  MANUAL
  AI_ASSISTED
  AI_GENERATED
}

// DinnerTag model - Tags associated with dinner events
model DinnerTag {
  id        String   @id @default(cuid())
  dinnerId  String
  tagId     String
  createdAt DateTime @default(now())

  // Relations
  dinner    Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([dinnerId, tagId])
  @@index([dinnerId])
  @@index([tagId])
}

// DinnerAddOn model - Optional add-ons for dinners (wine, beer, etc.)
model DinnerAddOn {
  id          String   @id @default(cuid())
  dinnerId    String
  name        String
  description String?  @db.Text
  price       Float    // Price in EUR
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dinner      Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)

  @@index([dinnerId])
}

// GroceryBill model - Grocery bills uploaded by hosts for transparency
model GroceryBill {
  id          String   @id @default(cuid())
  dinnerId    String
  imageUrl    String
  totalAmount Float?   // Total amount in EUR
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())

  // Relations
  dinner      Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)

  @@index([dinnerId])
}

// Booking model - User dinner reservations
model Booking {
  id                    String        @id @default(cuid())
  userId                String
  dinnerId              String
  status                BookingStatus @default(PENDING)
  numberOfGuests        Int
  basePrice              Float         // Base price total (basePricePerPerson * numberOfGuests)
  addOnsTotal            Float         @default(0) // Total for selected add-ons
  totalPrice             Float         // Total price (basePrice + addOnsTotal)
  selectedAddOns         Json?         // JSON array of { addOnId: string, quantity: number }
  referralCodeUsed       String?       // Moderator referral code used for this booking
  stripePaymentIntentId  String?       @unique
  createdAt              DateTime      @default(now())
  updatedAt              DateTime      @updatedAt

  // Relations
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  dinner                Dinner        @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  review                Review?
  messages              Message[]
  revenueShares         RevenueShare[]

  @@index([userId])
  @@index([dinnerId])
  @@index([status])
  @@index([referralCodeUsed])
  @@index([stripePaymentIntentId])
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

// SwipeAction model - Tinder-like swipe actions (like/pass on hosts)
model SwipeAction {
  id          String       @id @default(cuid())
  userId      String       // Guest who swiped
  targetUserId String      // Host being swiped on
  action      SwipeActionType
  createdAt   DateTime     @default(now())

  // Relations
  user        User         @relation("SwipeUser", fields: [userId], references: [id], onDelete: Cascade)
  targetUser  User         @relation("SwipeTarget", fields: [targetUserId], references: [id], onDelete: Cascade)

  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([targetUserId])
  @@index([action])
}

enum SwipeActionType {
  LIKE
  PASS
}

// Review model - Reviews for dinners
model Review {
  id        String   @id @default(cuid())
  bookingId String   @unique
  userId    String
  dinnerId  String
  rating    Int      // 1-5 stars
  comment   String?  @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  booking   Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  dinner    Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dinnerId])
  @@index([rating])
}

// Message model - Messaging between users
model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  bookingId   String?   // Optional context - message related to a booking
  content     String    @db.Text
  readAt      DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  sender      User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  recipient   User      @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  booking     Booking?  @relation(fields: [bookingId], references: [id], onDelete: SetNull)

  @@index([senderId])
  @@index([recipientId])
  @@index([bookingId])
  @@index([readAt])
}

// Better Auth tables

model Session {
  id            String   @id @default(cuid())
  userId        String
  expiresAt     DateTime
  token         String   @unique
  ipAddress     String?
  userAgent     String?
  impersonatedBy String?  // Admin ID if this session is impersonated
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  accountId         String
  providerId        String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  password          String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@unique([identifier, value])
  @@index([identifier])
  @@index([expiresAt])
}

model Passkey {
  id              String   @id @default(cuid())
  userId          String
  name            String
  credentialId   String   @unique
  publicKey       String
  counter         Int      @default(0)
  createdAt       DateTime @default(now())
  lastUsedAt      DateTime?

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialId])
}

// DinnerPlan model - AI-generated dinner planning data
model DinnerPlan {
  id              String   @id @default(cuid())
  dinnerId        String   @unique
  menuItems       Json     // Array of menu items with courses
  ingredientList  Json     // Shopping list with quantities
  prepTimeline    Json     // Timeline with steps
  pricingBreakdown Json    // Cost breakdown
  aiPrompt        String   @db.Text // Original prompt used
  aiResponse      String   @db.Text // Full AI response
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  dinner          Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
}

// RevenueShare model - Tracks moderator revenue shares from bookings
model RevenueShare {
  id              String            @id @default(cuid())
  moderatorId     String
  bookingId       String            @unique
  shareType       RevenueShareType
  basePercentage  Float            // Starting percentage (5.0)
  bookingNumber   Int               // Which booking this is (1st, 2nd, etc.)
  actualPercentage Float            // Calculated percentage after decrease
  amount          Float             // Actual EUR amount
  status          RevenueShareStatus @default(PENDING)
  paidAt          DateTime?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // Relations
  moderator       User              @relation(fields: [moderatorId], references: [id], onDelete: Cascade)
  booking         Booking           @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([moderatorId])
  @@index([status])
  @@index([shareType])
  @@index([createdAt])
}

enum RevenueShareType {
  ONBOARDING
  REFERRAL
}

enum RevenueShareStatus {
  PENDING
  PAID
  CANCELLED
}
