generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                        String            @id @default(cuid())
  utxosUserId               String?           @unique
  email                     String?           @unique
  name                      String?
  bio                       String?
  profileImageUrl           String?
  coverImageUrl             String?
  role                      UserRole          @default(USER)
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  emailVerified             Boolean           @default(false)
  banExpires                DateTime?
  banReason                 String?
  banned                    Boolean?          @default(false)
  hasCompletedGuestTour     Boolean           @default(false)
  hasCompletedHostTour      Boolean           @default(false)
  helpPreferences           Json?
  profileVisibility         ProfileVisibility @default(EVERYONE)
  referralCode              String?           @unique
  accounts                  Account[]
  bookings                  Booking[]
  dinners                   Dinner[]
  moderatedDinners          Dinner[]          @relation("DinnerModerator")
  receivedGuestReviews      GuestReview[]     @relation("GuestReviewsReceived")
  givenGuestReviews         GuestReview[]     @relation("HostGuestReviews")
  onboardedHostApplications HostApplication[] @relation("HostApplicationOnboarder")
  reviewedHostApplications  HostApplication[] @relation("HostApplicationReviewer")
  hostApplication           HostApplication?
  receivedMessages          Message[]         @relation("MessageRecipient")
  sentMessages              Message[]         @relation("MessageSender")
  passkeys                  Passkey[]
  revenueShares             RevenueShare[]
  reviews                   Review[]
  sessions                  Session[]
  targetSwipeActions        SwipeAction[]     @relation("SwipeTarget")
  swipeActions              SwipeAction[]     @relation("SwipeUser")
  userTags                  UserTag[]
  recipes                   Recipe[]
  recipeComments            RecipeComment[]
  recipeLikes               RecipeLike[]
  adminActionLogs           AdminActionLog[]

  @@index([utxosUserId])
  @@index([email])
  @@index([role])
  @@index([referralCode])
}

model HostApplication {
  id              String                @id @default(cuid())
  userId          String                @unique
  status          HostApplicationStatus @default(PENDING)
  applicationText String
  rejectionReason String?
  reviewedById    String?
  reviewedAt      DateTime?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  onboardedById   String?
  onboardedBy     User?                 @relation("HostApplicationOnboarder", fields: [onboardedById], references: [id])
  reviewedBy      User?                 @relation("HostApplicationReviewer", fields: [reviewedById], references: [id])
  user            User                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([userId])
  @@index([onboardedById])
}

model Tag {
  id         String      @id @default(cuid())
  name       String      @unique
  category   TagCategory
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  dinnerTags DinnerTag[]
  userTags   UserTag[]

  @@index([category])
  @@index([name])
}

model UserTag {
  id        String   @id @default(cuid())
  userId    String
  tagId     String
  createdAt DateTime @default(now())
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, tagId])
  @@index([userId])
  @@index([tagId])
}

model Dinner {
  id                 String                 @id @default(cuid())
  hostId             String
  title              String
  description        String
  cuisine            String?
  maxGuests          Int                    @default(10)
  basePricePerPerson Float                  @default(50.0)
  location           String
  dateTime           DateTime
  imageUrl           String?
  status             DinnerStatus           @default(DRAFT)
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  aiPlanData         Json?
  ingredientList     Json?
  menuItems          Json?
  moderatedAt        DateTime?
  moderatedById      String?
  moderationStatus   DinnerModerationStatus @default(PENDING)
  planningMode       PlanningMode           @default(MANUAL)
  prepTimeline       Json?
  bookings           Booking[]
  host               User                   @relation(fields: [hostId], references: [id], onDelete: Cascade)
  moderatedBy        User?                  @relation("DinnerModerator", fields: [moderatedById], references: [id])
  addOns             DinnerAddOn[]
  dinnerPlan         DinnerPlan?
  tags               DinnerTag[]
  groceryBills       GroceryBill[]
  guestReviews       GuestReview[]
  recipeUsages       RecipeUsage[]
  reviews            Review[]

  @@index([hostId])
  @@index([status])
  @@index([moderationStatus])
  @@index([dateTime])
}

model DinnerTag {
  id        String   @id @default(cuid())
  dinnerId  String
  tagId     String
  createdAt DateTime @default(now())
  dinner    Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  tag       Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([dinnerId, tagId])
  @@index([dinnerId])
  @@index([tagId])
}

model DinnerAddOn {
  id          String   @id @default(cuid())
  dinnerId    String
  name        String
  description String?
  price       Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  dinner      Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)

  @@index([dinnerId])
}

model GroceryBill {
  id          String   @id @default(cuid())
  dinnerId    String
  imageUrl    String
  totalAmount Float?
  uploadedAt  DateTime @default(now())
  createdAt   DateTime @default(now())
  dinner      Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)

  @@index([dinnerId])
}

model Booking {
  id                    String        @id @default(cuid())
  userId                String
  dinnerId              String
  status                BookingStatus @default(PENDING)
  numberOfGuests        Int
  basePrice             Float
  addOnsTotal           Float         @default(0)
  totalPrice            Float
  selectedAddOns        Json?
  stripePaymentIntentId String?       @unique
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  referralCodeUsed      String?
  dinner                Dinner        @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  guestReview           GuestReview?
  messages              Message[]
  revenueShares         RevenueShare?
  review                Review?

  @@index([userId])
  @@index([dinnerId])
  @@index([status])
  @@index([referralCodeUsed])
  @@index([stripePaymentIntentId])
}

model SwipeAction {
  id           String          @id @default(cuid())
  userId       String
  targetUserId String
  action       SwipeActionType
  createdAt    DateTime        @default(now())
  targetUser   User            @relation("SwipeTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  user         User            @relation("SwipeUser", fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, targetUserId])
  @@index([userId])
  @@index([targetUserId])
  @@index([action])
}

model Review {
  id                 String   @id @default(cuid())
  bookingId          String   @unique
  userId             String
  dinnerId           String
  comment            String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  cleanlinessStars   Int      @default(0)
  hospitalityStars   Int      @default(0)
  tasteStars         Int      @default(0)
  tipAmount          Float    @default(0)
  tipPaymentIntentId String?  @unique
  tipStars           Int      @default(0)
  booking            Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  dinner             Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dinnerId])
  @@index([hospitalityStars])
  @@index([cleanlinessStars])
  @@index([tasteStars])
}

model GuestReview {
  id        String         @id @default(cuid())
  bookingId String         @unique
  hostId    String
  guestId   String
  dinnerId  String
  sentiment GuestSentiment
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  booking   Booking        @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  dinner    Dinner         @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
  guest     User           @relation("GuestReviewsReceived", fields: [guestId], references: [id], onDelete: Cascade)
  host      User           @relation("HostGuestReviews", fields: [hostId], references: [id], onDelete: Cascade)

  @@index([hostId])
  @@index([guestId])
  @@index([dinnerId])
  @@index([sentiment])
}

model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  bookingId   String?
  content     String
  readAt      DateTime?
  createdAt   DateTime  @default(now())
  booking     Booking?  @relation(fields: [bookingId], references: [id])
  recipient   User      @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  sender      User      @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([recipientId])
  @@index([bookingId])
  @@index([readAt])
}

model Session {
  id             String   @id @default(cuid())
  userId         String
  expiresAt      DateTime
  token          String   @unique
  ipAddress      String?
  userAgent      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  impersonatedBy String?
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

model Account {
  id           String    @id @default(cuid())
  userId       String
  accountId    String
  providerId   String
  accessToken  String?
  refreshToken String?
  expiresAt    DateTime?
  password     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
  @@index([identifier])
  @@index([expiresAt])
}

model Passkey {
  id           String    @id @default(cuid())
  userId       String
  name         String
  credentialID String    @unique
  publicKey    String
  counter      Int       @default(0)
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  aaguid       String?
  backedUp     Boolean?
  deviceType   String?
  transports   String?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([credentialID])
}

model DinnerPlan {
  id               String   @id @default(cuid())
  dinnerId         String   @unique
  menuItems        Json
  ingredientList   Json
  prepTimeline     Json
  pricingBreakdown Json
  aiPrompt         String
  aiResponse       String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  dinner           Dinner   @relation(fields: [dinnerId], references: [id], onDelete: Cascade)
}

model RevenueShare {
  id               String             @id @default(cuid())
  moderatorId      String
  bookingId        String             @unique
  shareType        RevenueShareType
  basePercentage   Float
  bookingNumber    Int
  actualPercentage Float
  amount           Float
  status           RevenueShareStatus @default(PENDING)
  paidAt           DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  booking          Booking            @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  moderator        User               @relation(fields: [moderatorId], references: [id], onDelete: Cascade)

  @@index([moderatorId])
  @@index([status])
  @@index([shareType])
  @@index([createdAt])
}

model Recipe {
  id          String           @id @default(cuid())
  authorId    String
  title       String
  description String?
  imageUrl    String?
  isPublic    Boolean          @default(true)
  servings    Int?
  prepTime    String?
  cookTime    String?
  ingredients Json
  steps       Json
  tags        Json             @default("[]")
  viewCount   Int              @default(0)
  useCount    Int              @default(0)
  experience  Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  author      User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  comments    RecipeComment[]
  likes       RecipeLike[]
  usages      RecipeUsage[]

  @@index([authorId])
  @@index([isPublic])
  @@index([createdAt])
}

model RecipeUsage {
  id        String   @id @default(cuid())
  recipeId  String
  dinnerId  String?
  count     Int      @default(1)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  dinner    Dinner?  @relation(fields: [dinnerId], references: [id], onDelete: SetNull)

  @@index([recipeId])
  @@index([dinnerId])
}

model RecipeComment {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String
  content   String
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([userId])
}

model RecipeLike {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String
  createdAt DateTime @default(now())
  recipe    Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId])
  @@index([recipeId])
  @@index([userId])
}

model AdminActionLog {
  id         String   @id @default(cuid())
  actorId    String
  action     String
  entityType String
  entityId   String
  decision   String?
  note       String?
  createdAt  DateTime @default(now())
  actor      User     @relation(fields: [actorId], references: [id], onDelete: Cascade)

  @@index([actorId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

enum UserRole {
  USER
  HOST
  ADMIN
  MODERATOR
}

enum ProfileVisibility {
  EVERYONE
  ENGAGED_ONLY
}

enum HostApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum TagCategory {
  CUISINE
  DIETARY
  INTEREST
  LIFESTYLE
  SKILL
  OTHER
}

enum DinnerStatus {
  DRAFT
  PUBLISHED
  CANCELLED
  COMPLETED
}

enum DinnerModerationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PlanningMode {
  MANUAL
  AI_ASSISTED
  AI_GENERATED
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum SwipeActionType {
  LIKE
  PASS
}

enum RevenueShareType {
  ONBOARDING
  REFERRAL
}

enum RevenueShareStatus {
  PENDING
  PAID
  CANCELLED
}

enum GuestSentiment {
  LIKE
  DISLIKE
}
